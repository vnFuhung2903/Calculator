<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>
        My first template UwU
    </title>
    <link rel="stylesheet" type="text/css" href="ggcalc.css">
</head>

<body>

    <h1 id = "Head"> CALCULATOR </h1>
    <br>
    <p id = "PreAns"> Ans =0 </p>
    <p id = "Answer"> 0 </p>

    <div class = "Calculator">  
        <button class = "func" id = "Radian" onclick="changerad()"> Rad </button>
        <button class = "func" id = "Degree" onclick="changedeg()"> Deg </button>
        <button class = "func" onclick="addExpression('!')"> x! </button>
        <button class = "func" onclick="addExpression('(')"> ( </button>
        <button class = "func" onclick="addExpression(')')"> ) </button>
        <button class = "func" onclick="addExpression('%')"> % </button>
        <button class = "func" id = "Del" onclick="Delete()"> CE </button>
        <button class = "func" onclick="changeButton()"> Inv </button>
        <button class = "func" onclick="addExpression('sin')"> sin </button>
        <button class = "func" onclick="addExpression('ln')"> ln </button>
        <button class = "number" onclick="addExpression('7')"> 7 </button>
        <button class = "number" onclick="addExpression('8')"> 8 </button>
        <button class = "number" onclick="addExpression('9')"> 9 </button>
        <button class = "func" onclick="addExpression('/')"> / </button>
        <button class = "func" onclick="addExpression('π')"> π </button>
        <button class = "func" onclick="addExpression('cos')"> cos </button>
        <button class = "func" onclick="addExpression('log')"> log </button>
        <button class = "number" onclick="addExpression('4')"> 4 </button>
        <button class = "number" onclick="addExpression('5')"> 5 </button>
        <button class = "number" onclick="addExpression('6')"> 6 </button>
        <button class = "func" onclick="addExpression('*')"> * </button>
        <button class = "func" onclick="addExpression('e')"> e </button>
        <button class = "func" onclick="addExpression('tan')"> tan </button>
        <button class = "func" onclick="addExpression('√')"> √ </button>
        <button class = "number" onclick="addExpression('1')"> 1 </button>
        <button class = "number" onclick="addExpression('2')"> 2 </button>
        <button class = "number" onclick="addExpression('3')"> 3 </button>
        <button class = "func" onclick="addExpression('-')"> - </button>
        <button class = "func" onclick="addExpression('Ans')"> Ans </button>
        <button class = "func" onclick="addExpression('E')"> EXP </button>
        <button class = "func" onclick="addExpression('^')"> ^ </button>
        <button class = "number" onclick="addExpression('0')"> 0 </button>
        <button class = "number" onclick="addExpression('.')"> . </button>
        <button class = "func" id = "equal" onclick="Equal()"> = </button>
        <button class = "func" onclick="addExpression('+')"> + </button>
    </div>

    <script>
        var expression = [], stringex = "";
        let previousAns = 0, currentAns = 0;
        let isRad = 0, isAC = 0, isChange = 0;

        function changedeg() {
            isRad = 0;
            document.getElementById('Degree').style.color = "red";
            document.getElementById('Radian').style.color = "black";
        }
        function changerad() {
            isRad = 1;
            document.getElementById('Radian').style.color = "red";
            document.getElementById('Degree').style.color = "black";
        }
        function changeButton(){
            isChange = 1 - isChange
            
        }

        function addExpression(x) {
            if(isAC == 1){
                document.getElementById('Del').innerHTML = "CE";
                isAC = 0;
            }

            if(precedence(x) == 1) {
                if(stringex.length > 0 && precedence(stringex[stringex.length - 1]) == 1) return;
                if(stringex.length == 0 || !DigitChecking(stringex[stringex.length - 1])){
                    if(x == '+')    x = '0+';
                    else            x = '0-';
                }
            }
            if(precedence(x) == 2 && stringex.length > 0 && precedence(stringex[stringex.length - 1]) == 2) return;
            if(x == '!' && precedence(stringex[stringex.length - 1]) > 0) return;
            if(x == 'Ans')      expression.push(previousAns);
            else if(x == 'π')   expression.push(Math.PI);
            else if(x == 'e')   expression.push(Math.E);
            else                expression.push(x);

            if(x == '0+')   stringex = stringex + '+';
            else if(x == '0-') stringex = stringex + '-';
            else stringex = stringex + x;
            if(x == 'sin' || x == 'cos' || x == 'tan' || x == 'log' || x == 'ln' || x == '√'){
                stringex = stringex + '(';
                expression.push('(');
            }
            document.getElementById('PreAns').innerHTML = "Ans =" + previousAns;
            document.getElementById('Answer').innerHTML = stringex;
        }

        function Delete(){
            if(isAC == 1){
                document.getElementById('PreAns').innerHTML = "Ans =" + previousAns;
                document.getElementById('Answer').innerHTML = "0";
                document.getElementById('Del').innerHTML = "CE";
                isAC = 0;
                return;
            }
            let strsize = stringex.length; 
            let num = expression.pop().length;
            stringex = stringex.substr(0, strsize - num);
            document.getElementById('Answer').innerHTML = stringex;
        }

        function DigitChecking(id) {
            if(id - '0' >= 0 && id - '0' <= 9)  return true;
            return false;
        }

        function CheckArray(arr) {
            let numBracket = 0;
            for(let i = 0; i < arr.length; ++i){
                if(arr[i] == '(')   ++numBracket;
                if(arr[i] == ')')   --numBracket;
            }
            for(i = 1; i <= numBracket; ++i){
                expression.push(')');
                stringex = stringex + ')';
            }
        }

        function fixArray(arr) {
            var a = [];
            let size = arr.length;
            for(let i = 0; i < size; ++i){
                if(DigitChecking(arr[i])){
                    let number = arr[i] - '0';
                    let base = 10, j = i + 1;
                    while(j < size){
                        if(arr[j] == '.' && base == 10){
                            base = 0.1;
                            ++j;
                            continue;
                        }
                        if(!DigitChecking(arr[j]))  break;
                        if(base == 10)  number = number * base + (arr[j] - '0');
                        else{
                            number = number + (arr[j] - '0') * base;
                            base *= 0.1;
                        }
                        ++j;
                    }
                    i = j - 1;
                    a.push(number);
                    positive = 1;
                    continue;
                }
                a.push(arr[i]);
            }
            Postfix(a);
        }

        function precedence(ope) {
            if(ope == '√' || ope.length > 1 || ope == '0+' || ope == '0-') return 4;
            if(ope == '^' || ope == '%' || ope == 'E' || ope == '!')    return 3;
            if(ope == '*' || ope == '/')    return 2;
            if(ope == '+' || ope == '-')    return 1;
            return 0;
        }

        function Postfix(arr) {
            let stack = [], postarr = [];
            let index = "", postdex = "";
            let arraySize = arr.length, j = 0;
            for(let i = 0; i < arraySize; ++i){
                postdex = arr[i];
                if(!isNaN(arr[i])){
                    postarr.push(postdex);
                    continue;
                }
                if(postdex == '('){
                    stack.push('(');
                    continue;
                }
                if(postdex == ')'){
                    index = stack.pop();
                    while(stack.length >= 1 && index != '('){
                        postarr.push(index);
                        index = stack.pop();
                    }
                    continue;
                }
                while(stack.length >= 1 && precedence(postdex) <= precedence(stack[stack.length - 1])){
                    index = stack.pop();
                    postarr.push(index);
                }
                stack.push(postdex);
            }
            while(stack.length >= 1){
                index = stack.pop();
                postarr.push(index);
            }
            Calculate(postarr);
        }

        function OpeChecking(ope) {
            if(ope == '+' || ope == '-' || ope == '*' || ope == '/' || ope == '^' || ope == 'E')  return 1;
            return 0;
        }

        function roundeps(x) {
            if(-1e-11 <= x && x <= 1e-11)   return 0;
            return x;
        }

        function Result1(x, ope) {
            if(ope == '0+') return x;
            if(ope == '0-') return -x;
            if(ope == "%")  return x / 100;
            if(ope == "sin") return roundeps(Math.sin((1 - isRad) * x * Math.PI / 180 + isRad * x));
            if(ope == "cos") return roundeps(Math.cos((1 - isRad) * x * Math.PI / 180 + isRad * x));
            if(ope == "tan") return roundeps(roundeps(Math.sin((1 - isRad) * x * Math.PI / 180 + isRad * x)) / roundeps(Math.cos((1 - isRad) * x * Math.PI / 180 + isRad * x)));
            if(ope == "log") return Math.log10(x);
            if(ope == "ln") return Math.log(x);
            if(ope == "√") return Math.sqrt(x);
            if(ope == '!') return Factorial(x);
        }

        function Factorial(x) {
            let res = 1;
            for(let i = 2; i <= x; ++i)
                res = res * i;
            return res;
        }

        function Result2(x, y, ope){
            if(ope == "+") return x + y;
            if(ope == "-") return x - y;
            if(ope == "*") return x * y;
            if(ope == "/") return x / y;
            if(ope == "^") return Math.pow(x, y);
            if(ope == 'E') return x * Math.pow(10, y);
        }

        function Calculate(arr) {
            let stack = [];
            let arraySize = arr.length;
            for(let i = 0; i < arraySize; ++i){
                if(!isNaN(arr[i])){
                    stack.push(arr[i]);
                    continue;
                }
                if(OpeChecking(arr[i]) && stack.length > 1){
                    let x = stack.pop();
                    let y = stack.pop();
                    stack.push(Result2(y, x, arr[i]));
                    continue;
                }

                let x = stack.pop();
                stack.push(Result1(x, arr[i]));
            }
            currentAns = stack.pop();
        }

        function Equal() {
            if(stringex == "") return;
            CheckArray(expression);
            document.getElementById('PreAns').innerHTML = stringex + "=";
            fixArray(expression);
            document.getElementById('Answer').innerHTML = (!isNaN(currentAns) ? currentAns : "Error");
            previousAns = currentAns;
            expression = [];
            stringex = "";
            document.getElementById('Del').innerHTML = "AC";
            isAC = 1;
        }

    </script>
        
</body>
</html>

